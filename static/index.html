<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Procrastinate Professional</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      min-height: 100vh;
      color: #f8f9fa;
    }
    body.dark-mode {
      background: linear-gradient(135deg, #0f0f1a, #0a0a1a);
    }
    .todo-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    body.dark-mode .todo-container {
      background: rgba(35, 39, 43, 0.8);
      color: #f8f9fa;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
    .todo-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    body.dark-mode .todo-item {
      background: rgba(35, 39, 43, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #f8f9fa;
    }
    .todo-item.completed {
      opacity: 0.7;
      background-color: rgba(248, 249, 250, 0.1);
    }
    body.dark-mode .todo-item.completed {
      background-color: rgba(24, 26, 27, 0.8);
    }
    .todo-item.completed .todo-text {
      text-decoration: line-through;
      color: #adb5bd;
    }
    body.dark-mode .todo-item.completed .todo-text {
      color: #adb5bd;
    }
    .connection-status {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    .connection-status.connected {
      background-color: rgba(25, 135, 84, 0.9);
      color: white;
    }
    .connection-status.disconnected {
      background-color: rgba(220, 53, 69, 0.9);
      color: white;
    }
    .todo-input-group {
      position: relative;
    }
    .todo-input-group .btn {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      background: rgba(13, 110, 253, 0.8);
      border: none;
      color: white;
    }
    .todo-input-group .form-control {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
    }
    .todo-input-group .form-control::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    .todo-input-group .form-control:focus {
      box-shadow: none;
      border-color: rgba(255, 255, 255, 0.2);
    }
    .todo-stats {
      font-size: 0.875rem;
      color: #adb5bd;
      margin-bottom: 1rem;
    }
    body.dark-mode .todo-stats {
      color: #adb5bd;
    }
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #adb5bd;
    }
    body.dark-mode .empty-state {
      color: #adb5bd;
    }
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    .form-check-input:checked {
      background-color: #198754;
      border-color: #198754;
    }
    .btn-danger {
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .btn-danger:hover {
      opacity: 1;
    }
    .thinking-bubble {
      display: none;
      position: fixed;
      bottom: 5rem;
      right: 1rem;
      background-color: rgba(13, 110, 253, 0.9);
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: 20px;
      font-size: 0.875rem;
      z-index: 1000;
      backdrop-filter: blur(5px);
      animation: pulse 1.5s infinite;
    }
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-weight: 600;
      color: #f8f9fa;
      font-size: 1.5rem;
    }
    body.dark-mode h1,
    body.dark-mode h2,
    body.dark-mode h3,
    body.dark-mode h4,
    body.dark-mode h5,
    body.dark-mode h6 {
      color: #f8f9fa;
    }
    @keyframes pulse {
      0% {
        opacity: 0.6;
      }
      50% {
        opacity: 1;
      }
      100% {
        opacity: 0.6;
      }
    }
    .darkmode-switch {
      position: absolute;
      top: 1.5rem;
      right: 2rem;
      z-index: 10;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #f8f9fa;
      transition: all 0.3s ease;
    }
    .darkmode-switch:hover {
      background: rgba(255, 255, 255, 0.2);
    }
  </style>
</head>

<body>
  <div class="container todo-container position-relative">
    <button id="darkModeSwitch" class="btn btn-outline-secondary darkmode-switch" title="Toggle light/dark mode">
      <i id="darkModeIcon" class="bi bi-moon"></i>
    </button>
    <div class="row mb-4">
      <div class="col">
        <h1 class="text-center mb-4">AI Task Manager</h1>
        <div class="todo-stats text-center">
          <span id="todoCount">0</span> tasks remaining
        </div>
        <div class="input-group todo-input-group mb-3">
          <input type="text" id="todoInput" class="form-control" autofocus placeholder="What needs to be done?">
          <div class="input-group-append">
            <button class="btn btn-primary" onclick="addTodo()"> <i class="bi bi-plus-lg"></i> Add Todo </button>
          </div>
        </div>
        <div class="input-group todo-input-group mb-3">
          <input type="text" id="todoSearch" class="form-control" placeholder="Search">
          <!-- <div class="input-group-append"> -->
          <!--   <button class="btn btn-primary" onclick="addTodo()"> <i class="bi bi-plus-lg"></i> Add Todo </button> -->
          <!-- </div> -->
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div id="todoList" class="list-group">
          <!-- Todo items will be added here -->
        </div>
        <div id="emptyState" class="empty-state" style="display: none;">
          <i class="bi bi-check2-circle"></i>
          <h4>No tasks yet!</h4>
          <p>Add a task to get started.</p>
        </div>
      </div>
    </div>
  </div>

  <div id="connectionStatus" class="connection-status disconnected">
    <i class="bi bi-circle-fill"></i> Disconnected
  </div>

  <div id="thinkingBubble" class="thinking-bubble">
    <i class="bi bi-cpu"></i> AI is thinking...
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let ws;
    let todos = [];
    let todosAll = [];

    function connect() {
      //extract websocket address from the URL
      let websocketAddress = window.location.href;
      websocketAddress = websocketAddress.replace("/static", "/ws").replace("http", "ws").replace("https", "wss").replace(/\/$/, "");
      ws = new WebSocket(websocketAddress);

      ws.onopen = function () {
        console.log("Connected to WebSocket server");
        updateConnectionStatus(true);
      };

      ws.onmessage = function (event) {
        try {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        } catch (e) {
          console.error("Error parsing message:", e);
        }
      };

      ws.onclose = function () {
        console.log("WebSocket connection closed, retrying...");
        updateConnectionStatus(false);
        setTimeout(connect, 1000);
      };

      ws.onerror = function (error) {
        console.error("WebSocket error:", error);
        updateConnectionStatus(false);
      };
    }

    function updateConnectionStatus(connected) {
      const status = document.getElementById('connectionStatus');
      if (connected) {
        status.className = 'connection-status connected';
        status.innerHTML = '<i class="bi bi-circle-fill"></i> Connected';
      } else {
        status.className = 'connection-status disconnected';
        status.innerHTML = '<i class="bi bi-circle-fill"></i> Disconnected';
      }
    }

    function addTodo() {
      const input = document.getElementById("todoInput");
      const text = input.value.trim();

      if (text) {
        const todo = {
          id: Date.now(),
          text: text,
          completed: false
        };

        // Show thinking bubble
        document.getElementById('thinkingBubble').style.display = 'block';

        // Send to server first
        ws.send(JSON.stringify({
          type: 'add_todo',
          todo: todo
        }));

        input.value = "";
        input.focus();
      }
    }

    document.getElementById('todoSearch').addEventListener('input', searchTodos);

    function searchTodos() {
      const searchTerm = document.getElementById('todoSearch').value.toLowerCase();

      todos = todosAll.filter(todo => todo.text.toLowerCase().includes(searchTerm));
      renderTodos()
    }
    function handleWebSocketMessage(data) {
      if (data.type === 'todo_list') {
        todos = data.todos;
        todosAll = data.todos;
        renderTodos();
      } else if (data.type === 'todo_added') {
        // Hide thinking bubble when server confirms
        document.getElementById('thinkingBubble').style.display = 'none';

        // Check if the todo already exists
        const existingIndex = todos.findIndex(t => t.id === data.todo.id);
        if (existingIndex === -1) {
          // If it doesn't exist, add it
          todos.push(data.todo);
        } else {
          // If it exists, update it with the server's version
          todos[existingIndex] = data.todo;
        }
        renderTodos();
      } else if (data.type === 'todo_updated') {
        const index = todos.findIndex(t => t.id === data.todo.id);
        if (index !== -1) {
          todos[index] = data.todo;
          renderTodos();
        }
      } else if (data.type === 'todo_deleted') {
        todos = todos.filter(t => t.id !== data.todoId);
        renderTodos();
      }
    }

    function renderTodos() {
      const todoList = document.getElementById('todoList');
      const emptyState = document.getElementById('emptyState');
      const todoCount = document.getElementById('todoCount');

      // Update todo count
      const remainingTodos = todos.filter(t => !t.completed).length;
      todoCount.textContent = remainingTodos;

      // Show/hide empty state
      if (todos.length === 0) {
        todoList.style.display = 'none';
        emptyState.style.display = 'block';
      } else {
        todoList.style.display = 'block';
        emptyState.style.display = 'none';
      }

      todoList.innerHTML = todos.map(todo => `
                <div class="todo-item ${todo.completed ? 'completed' : ''}" data-id="${todo.id}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="form-check flex-grow-1">
                            <input class="form-check-input" type="checkbox" 
                                   ${todo.completed ? 'checked' : ''} 
                                   onchange="toggleTodo(${todo.id})">
                            <label class="form-check-label todo-text">
                                ${todo.text}
                            </label>
                            <div class="todo-details mt-2">
                                ${todo.category ? `<span class="badge bg-secondary me-2">${todo.category}</span>` : ''}
                                ${todo.tags && todo.tags.length > 0 ? todo.tags.map(tag =>
        `<span class="badge bg-info me-1">${tag}</span>`
      ).join('') : ''}
                                ${todo.duedate ? `<span class="badge bg-warning me-2"><i class="bi bi-calendar"></i> ${todo.duedate}</span>` : ''}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-danger ms-2" onclick="deleteTodo(${todo.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
    }

    function toggleTodo(id) {
      const todo = todos.find(t => t.id === id);
      if (todo) {
        todo.completed = !todo.completed;
        ws.send(JSON.stringify({
          type: 'update_todo',
          todo: todo
        }));
      }
    }

    function deleteTodo(id) {
      ws.send(JSON.stringify({
        type: 'delete_todo',
        todoId: id
      }));
    }

    // Handle Enter key in input
    document.getElementById('todoInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        addTodo();
      }
    });

    // Dark mode logic
    function setDarkMode(enabled) {
      if (enabled) {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeIcon').className = 'bi bi-sun';
      } else {
        document.body.classList.remove('dark-mode');
        document.getElementById('darkModeIcon').className = 'bi bi-moon';
      }
      localStorage.setItem('darkMode', enabled ? '1' : '0');
    }
    function toggleDarkMode() {
      const enabled = !document.body.classList.contains('dark-mode');
      setDarkMode(enabled);
    }
    document.getElementById('darkModeSwitch').addEventListener('click', toggleDarkMode);
    // On load, set mode from localStorage or system preference
    (function() {
      const saved = localStorage.getItem('darkMode');
      if (saved === '1' || (saved === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        setDarkMode(true);
      } else {
        setDarkMode(false);
      }
    })();

    connect();
  </script>
</body>

</html>
